{% extends "base.html" %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}
Индивидуальные уроки
{% endblock %}

{% block content %}

<div class="container my-5">
    <div class="row">
        <div class="col-6">
            <h1>{% now "F Y" %}</h1>
            <h4>Ваше текущее время: {% now "d/m/Y H:i" %}</h4>
            <h4>Осталось занятий: {{student.hours_paid}}</h4>
            <h4><a href="">Получать уведомления в telegram</a></h4>
        </div>
        <div class="col-6">
            <div class="d-flex gap-3 align-items-end">
                <img src="{{student.teacher.photo.url}}" alt="" class="img-fluid">
                <div>
                    <h4>Ваш преподаватель</h4>
                    <h2>{{student.teacher}}</h2>

                    <h4>
                        <button class="btn btn-primary" type="button" data-bs-toggle="collapse"
                            data-bs-target="#changeTeacher" aria-expanded="false" aria-controls="changeTeacher">
                            <i class="bi bi-chevron-down"></i> Выбрать другого
                        </button>
                    </h4>
                </div>
            </div>

            <div class="collapse mt-3" id="changeTeacher">
                <div class="card card-body">
                    <form method="post" action="{% url 'individual_lessons_change_teacher' gc_user %}">
                        {% csrf_token %}
                        {{ change_teacher_form|crispy }}
                        <button type="submit" class="btn btn-primary w-100 mx-1">Сохранить</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container my-5">
    <div id="new-lesson">
        <p class="d-inline-flex gap-1">
            <a class="btn btn-primary" data-bs-toggle="collapse" href="#newLesson" role="button" aria-expanded="false"
                aria-controls="newLesson">
                + Добавить урок
            </a>
        </p>
        <div class="collapse container bg-white p-3 rounded-3" id="newLesson">
            <form method="post">
                {% csrf_token %}
                <div class="d-flex gap-4">
                    {{ form|crispy }}
                </div>
                <div class="d-flex">
                    <button type="submit" class="btn btn-primary w-100 mx-1">Сохранить</button>
                    <button type="cancel" class="btn btn-secondary w-100 mx-1">Отменить</button>
                </div>
            </form>
        </div>
    </div>
</div>


<div class="container my-5" id="myLessons">
    <h1>Ваши ближайшие занятия</h1>

    {% for les in my_lessons %}
    <div class="container my-4">
        <form method="post" action="{% url 'individual_lessons_delete_lesson' gc_user %}" class="row">
            {% csrf_token %}
            <div class="col-10 bg-white p-3 rounded-3">
                <div class="d-flex gap-4">
                    {{ les|crispy }}
                </div>
            </div>
            <div class="col-2 d-flex gap-2 lessonsBtn d-flex align-items-center">
                <button class="btn text-white fs-4" style="background-color: #BD9F8F;" type="submit">
                    <i class="bi bi-x-lg"></i>
                </button>
                <a class="btn btn-primary fs-4 w-100" href="{{les.zoom_url.value}}">
                    <span class="fs-5">Войти</span>
                </a>
            </div>
        </form>
    </div>

    {% endfor %}
</div>

<!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous"> -->



<div class="container my-4 bg-white p-4 rounded-3">
    <div id="carouselExample" class="carousel slide">
        <div class="carousel-inner">
            <div class="d-flex flex-row gap-3 mb-4">
                <button class="btn fs-4" data-bs-target="#carouselExample" data-bs-slide="prev" disabled>
                    <i class="bi bi-arrow-left-circle-fill text-primary"></i>
                </button>
                <button class="btn fs-4 text-primary" onclick="currentWeek(this)">
                    Сегодня
                </button>
                <button class="btn fs-4" data-bs-target="#carouselExample" data-bs-slide="next">
                    <i class="bi bi-arrow-right-circle-fill text-primary"></i>
                </button>
            </div>
            <div class="carousel-item active">
                <div class="row">
                    {% for data in calendar|slice:":7" %}
                    <div class="col text-center">
                        <div>
                            {{ data.lesson_date|date:"D" }}
                            <br>
                            <h3
                                class="p-2 {% if data.lesson_date|date:'Y-m-d' == now|date:'Y-m-d' %}bg-primary rounded-circle text-white today{% endif %}">
                                {{ data.lesson_date|date:"j" }}
                            </h3>
                        </div>

                        {% for lesson in data.lessons_on_date %}
                        <div class="mx-1 fs-5">
                            {{lesson.time}}
                        </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="carousel-item">
                <div class="row">
                    {% for data in calendar|slice:"7:14" %}
                    <div class="col text-center">
                        <div>
                            {{ data.lesson_date|date:"D" }}
                            <br>
                            <h3 class="p-2">
                                {{ data.lesson_date|date:"j" }}
                            </h3>
                        </div>

                        {% for lesson in data.lessons_on_date %}
                        <div class="mx-1 fs-5">
                            {{lesson.time}}
                        </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            <div class="carousel-item">
                <div class="row">
                    {% for data in calendar|slice:"14:" %}
                    <div class="col text-center">
                        <div>
                            {{ data.lesson_date|date:"D" }}
                            <br>
                            <h3 class="p-2">
                                {{ data.lesson_date|date:"j" }}
                            </h3>
                        </div>

                        {% for lesson in data.lessons_on_date %}
                        <div class="mx-1 fs-5">
                            {{lesson.time}}
                        </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

    </div>
</div>




<script>
    $('#newLesson form .mb-3').addClass('w-100');
    $('#myLessons form .mb-3').addClass('w-100');

    $('#newLesson form #div_id_time select').on('click', function (e) {
        if ($('#newLesson form #div_id_time select').attr('disabled') == 'disabled') {
            console.log('no time')
        }
    })

    $('#newLesson form #div_id_date input').on('input', function (e) {
        date = $('#newLesson form #div_id_date input').val();
        if (date) {
            $.getJSON(
                "{% url 'individual_lessons_get_date' gc_user %}",
                {
                    'date': date,
                },
                function (data) {
                    if (data && data['available_time'].length > 0) {
                        html = "";
                        data['available_time'].forEach(element => {
                            html += `<option value="${element}">${element}</option>\n`
                        });
                        time_select = document.querySelector('#id_time');
                        time_select.innerHTML = html;
                        time_select.disabled = false;
                    } else {
                        alert('Нет доступного времени для записи');
                    }
                }
            );
        }
    });






    const carouselExampleElement = document.querySelector('#carouselExample')

    const carousel = new bootstrap.Carousel(carouselExampleElement, {
        // interval: 1000,
        wrap: false
    });

    $('#carouselExample').on('slid.bs.carousel', '', function () {
        console.log(this)
        var $this = $(this);

        this.querySelector('.bi-arrow-left-circle-fill').closest('button').disabled = false;
        this.querySelector('.bi-arrow-right-circle-fill').closest('button').disabled = false;

        if (document.querySelector('.carousel-inner .carousel-item').classList.contains('active')) {
            console.log(123)
            this.querySelector('.bi-arrow-left-circle-fill').closest('button').disabled = true;
        } else if (document.querySelector('.carousel-inner .carousel-item:last-child').classList.contains('active')) {
            console.log(1223)
            this.querySelector('.bi-arrow-right-circle-fill').closest('button').disabled = true;
        }

    });


    function currentWeek(btn) {
        carousel.to(0);
    }
</script>


<style>
    #newLesson form .mb-3,
    #myLessons form .mb-3 {
        width: 100%;
        display: flex;
        align-items: center;
    }

    #myLessons form .mb-3 {
        margin-bottom: 0 !important;
    }


    #newLesson form .mb-3 label,
    #myLessons form .mb-3 label {
        margin-bottom: 0;
        margin-right: 1rem;
    }

    #newLesson form .mb-3 input,
    #newLesson form .mb-3 select,
    #myLessons form .mb-3 input,
    #myLessons form .mb-3 select {
        background-color: #E6E6E6;
    }

    #newLesson form .asteriskField,
    #myLessons form .asteriskField {
        display: none;
    }

    .carousel-inner .btn:disabled {
        border-color: transparent !important;
    }

    .carousel-inner .today {
        aspect-ratio: 1/1;
        display: inline-block;
    }
</style>

{% endblock %}